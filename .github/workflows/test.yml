name: CI

on:
  workflow_dispatch:

jobs:
  secure-test:
    runs-on: macos-latest

    steps:
      - name: Enable Screen Sharing (VNC)
        run: |
          # Enable Screen Sharing (VNC - macOS equivalent of RDP)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "TempPass123!" \
            -restart -agent -privs -all

      - name: Create User with Secure Password
        run: |
          # Generate secure password
          PASSWORD=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-12)!Aa1
          
          # Create user
          sudo dscl . -create /Users/test
          sudo dscl . -create /Users/test UserShell /bin/bash
          sudo dscl . -create /Users/test RealName "Test User"
          sudo dscl . -create /Users/test UniqueID 1001
          sudo dscl . -create /Users/test PrimaryGroupID 20
          sudo dscl . -create /Users/test NFSHomeDirectory /Users/test
          sudo dscl . -passwd /Users/test "$PASSWORD"
          sudo dscl . -append /Groups/admin GroupMembership test
          
          # Create home directory
          sudo createhomedir -c -u test
          
          # Save credentials to environment
          echo "test_CREDS=User: test | Password: $PASSWORD" >> $GITHUB_ENV
          echo "test_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          # Download and install Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/Tailscale-latest-macos.pkg -o tailscale.pkg
          sudo installer -pkg tailscale.pkg -target /
          rm tailscale.pkg
          
          # Wait for installation
          sleep 5

      - name: Connect to Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # Start Tailscale
          sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale up \
            --authkey="${TAILSCALE_AUTH_KEY}" \
            --hostname="gh-runner-${GITHUB_RUN_ID}"
          
          # Get Tailscale IP
          retry=0
          while [ $retry -lt 10 ]; do
            TAILSCALE_IP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4 2>/dev/null | head -n1)
            if [ -n "$TAILSCALE_IP" ]; then
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            sleep 5
            retry=$((retry+1))
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
            echo "Failed to get Tailscale IP"
            exit 1
          fi

      - name: Verify
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "VNC is enabled on port 5900"
          
          # Show Tailscale status
          /Applications/Tailscale.app/Contents/MacOS/Tailscale status

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== CONNECTION INFO ==="
          echo "Address: $TAILSCALE_IP"
          echo "VNC Port: 5900"
          echo "Username: test"
          echo "Password: $test_PASSWORD"
          echo "===================="
          echo ""
          echo "Connect using: vnc://test@$TAILSCALE_IP:5900"
          echo ""
          
          # Keep runner active
          while true; do
            echo "[$(date)] Active - Cancel workflow to terminate"
            sleep 300
          done
