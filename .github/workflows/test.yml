name: CIS

on:
  workflow_dispatch:

jobs:
  secure-test:
    runs-on: macos-latest

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/Tailscale-latest-macos.pkg -o Tailscale-latest.pkg
          sudo installer -pkg Tailscale-latest.pkg -target /
          rm Tailscale-latest.pkg

      - name: Start Tailscale with auth key
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # Full path to Tailscale CLI
          TAILSCALE_CLI="/Applications/Tailscale.app/Contents/MacOS/Tailscale"

          sudo "$TAILSCALE_CLI" up --authkey=${TAILSCALE_AUTH_KEY} --hostname=gh-runner-${GITHUB_RUN_ID}

          # Get IP
          retry=0
          while [ $retry -lt 10 ]; do
            IP=$("$TAILSCALE_CLI" ip -4 | head -n1)
            if [ -n "$IP" ]; then
              echo "TAILSCALE_IP=$IP" >> "$GITHUB_ENV"
              break
            fi
            sleep 5
            retry=$((retry+1))
          done

          if [ -z "$IP" ]; then
            echo "Tailscale IP not found. Exiting."
            exit 1
          fi

      - name: Show Tailscale Info
        run: |
          echo "Tailscale IP is $TAILSCALE_IP"
          echo "Runner: gh-runner-${GITHUB_RUN_ID}"

      - name: Keep Runner Alive for Remote Debugging
        run: |
          echo "Keeping runner alive..."
          while true; do
            echo "[$(date)] Runner active - Ctrl+C or Cancel to stop"
            sleep 300
          done
