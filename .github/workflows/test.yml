name: Disala - MacOS RDP
on: 
  workflow_dispatch:

jobs:
  build:
    name: Disala - MacOS RDP - Tailscale
    runs-on: macos-latest
    
    steps:
    - name: Quick Setup
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # Setup VNC with simple password
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -configure -allowAccessFor -allUsers \
          -configure -restart -agent -privs -all
        
        # Install and start Tailscale
        brew install tailscale
        sudo tailscaled > /dev/null 2>&1 &
        sleep 5
        
        # Connect
        tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="mac-${GITHUB_RUN_ID}"
        
        # Get connection info
        TAILSCALE_IP=$(tailscale ip -4 | head -n1)
        
        echo "===================================="
        echo "VNC: vnc://$TAILSCALE_IP:5900"
        echo "User: runner (or use current user)"
        echo "===================================="

    - name: Keep Alive
      run: |
        while true; do
          echo "[$(date)] Active - Cancel workflow to stop"
          sleep 300
        done
