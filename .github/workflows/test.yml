name: Disala - MacOS RDP
on: 
  workflow_dispatch:

jobs:
  build:
    name: Disala - MacOS RDP - Tailscale
    runs-on: macos-latest
    
    steps:
    - name: Create RDP User with Strong Password
      run: |
        # Generate strong random password
        PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | head -c 12)
        SPECIAL=$(echo '!@#$%^&*' | fold -w1 | shuf | head -n2 | tr -d '\n')
        NUMBER=$(echo '0123456789' | fold -w1 | shuf | head -n2 | tr -d '\n')
        FINAL_PASSWORD="${PASSWORD}${SPECIAL}${NUMBER}"
        
        # Create RDP user
        sudo dscl . -create /Users/rdp
        sudo dscl . -create /Users/rdp UserShell /bin/bash
        sudo dscl . -create /Users/rdp RealName "RDP User"
        sudo dscl . -create /Users/rdp UniqueID 1001
        sudo dscl . -create /Users/rdp PrimaryGroupID 20
        sudo dscl . -create /Users/rdp NFSHomeDirectory /Users/rdp
        sudo dscl . -passwd /Users/rdp "$FINAL_PASSWORD"
        sudo dscl . -append /Groups/admin GroupMembership rdp
        
        # Create home directory
        sudo createhomedir -c -u rdp
        
        # Save password
        echo "RDP_PASSWORD=$FINAL_PASSWORD" >> $GITHUB_ENV
        
        # Enable VNC
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$FINAL_PASSWORD" \
          -configure -allowAccessFor -specifiedUsers \
          -configure -access -on -users rdp \
          -configure -restart -agent -privs -all

    - name: Install and Setup Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # Install Tailscale via Homebrew
        brew install tailscale
        
        # Start Tailscale daemon
        sudo tailscaled > /dev/null 2>&1 &
        sleep 10
        
        # Connect to Tailscale
        tailscale up \
          --authkey="${TAILSCALE_AUTH_KEY}" \
          --hostname="macos-rdp-${GITHUB_RUN_ID}"
        
        # Get IP
        sleep 10
        TAILSCALE_IP=$(tailscale ip -4 | head -n1)
        
        if [ -z "$TAILSCALE_IP" ]; then
          echo "Failed to get Tailscale IP"
          tailscale status
          exit 1
        fi
        
        echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
        tailscale status

    - name: Display Connection Information
      run: |
        echo ""
        echo "=============================================="
        echo "    ‚úÖ MACOS VNC SERVER READY TO CONNECT"
        echo "=============================================="
        echo ""
        echo "üì° CONNECTION DETAILS:"
        echo "----------------------------------------------"
        echo ""
        echo "üåê Tailscale IP Address: $TAILSCALE_IP"
        echo "üîå VNC Port: 5900"
        echo ""
        echo "üîó Quick Connect URL:"
        echo "   vnc://rdp@$TAILSCALE_IP:5900"
        echo ""
        echo "----------------------------------------------"
        echo "üîê LOGIN CREDENTIALS:"
        echo "----------------------------------------------"
        echo ""
        echo "üë§ Username: rdp"
        echo "üîë Password: $RDP_PASSWORD"
        echo ""
        echo "=============================================="
        echo ""
        echo "üìù HOW TO CONNECT:"
        echo "   1. Open VNC Viewer (RealVNC, TightVNC, etc)"
        echo "   2. Enter: $TAILSCALE_IP:5900"
        echo "   3. Use the credentials above"
        echo ""
        echo "=============================================="

    - name: Keep Session Active
      run: |
        echo "‚úÖ System ready - Cancel workflow when done"
        
        while true; do
          echo "[$(date '+%H:%M:%S')] Active | IP: $TAILSCALE_IP | User: rdp"
          sleep 300
        done
